<h1 class="fare">
  <button id="toggle-form" class="toggle-button">ï¼‹ æ¬é€æ–™ç™»éŒ²</button>
</h1>

<div id="fare-form" style="display: none;">
  <%= form_with model: @fare, local: true do |form| %>
    <div>
      <%= form.label :departure, "å‡ºç™ºåœ°ï¼ˆæ–°è¦ã¾ãŸã¯é¸æŠï¼‰" %><br>
      <%= form.text_field :departure, id: "departure-input", required: true, placeholder: "æ–°ã—ã„å‡ºç™ºåœ°ã‚’å…¥åŠ›" %><br>
      <small>ã¾ãŸã¯ä»¥ä¸‹ã‹ã‚‰é¸æŠï¼š</small><br>
      <%= select_tag :departure_select,
      options_from_collection_for_select(Fare.select(:departure).distinct, :departure, :departure, ""),
      include_blank: true, id: "departure-select" %>

    </div>

    <div>
      <%= form.label :departure_furigana, "å‡ºç™ºåœ°ï¼ˆãµã‚ŠãŒãªï¼‰" %><br>
      <%= form.text_field :departure_furigana, id: "departure-furigana", placeholder: "è‡ªå‹•å…¥åŠ›ã¾ãŸã¯å…¥åŠ›" %>
    </div>

    <hr>

    <div>
      <%= form.label :arrival, "åˆ°ç€åœ°ï¼ˆæ–°è¦ã¾ãŸã¯é¸æŠï¼‰" %><br>
      <%= form.text_field :arrival, id: "arrival-input", required: true, placeholder: "æ–°ã—ã„åˆ°ç€åœ°ã‚’å…¥åŠ›" %><br>
      <small>ã¾ãŸã¯ä»¥ä¸‹ã‹ã‚‰é¸æŠï¼š</small><br>
      <%= select_tag :arrival_select,
      options_from_collection_for_select(Fare.select(:arrival).distinct, :arrival, :arrival, ""),
      include_blank: true, id: "arrival-select" %>

    </div>

    <div>
      <%= form.label :arrival_furigana, "åˆ°ç€åœ°ï¼ˆãµã‚ŠãŒãªï¼‰" %><br>
      <%= form.text_field :arrival_furigana, id: "arrival-furigana", placeholder: "è‡ªå‹•å…¥åŠ›ã¾ãŸã¯å…¥åŠ›" %>
    </div>

    <hr>


    <div>
      <%= form.label :distance, "è·é›¢ï¼ˆä»»æ„ï¼‰" %><br>
      <div class="input-with-unit">
        <%= form.number_field :distance, step: 0.1, placeholder: "100" %>
        <span class="unit">km</span>
      </div>
    </div>

    <hr>

    <div>
      <%= form.label :fare_small, "å°å‹æ–™é‡‘" %><br>
      <div class="input-with-unit">
        <%= form.number_field :fare_small, required: true, placeholder: "30000" %>
        <span class="unit">å††</span>
      </div>
    </div>

    <div>
      <%= form.label :fare_medium, "ä¸­å‹æ–™é‡‘" %><br>
      <div class="input-with-unit">
        <%= form.number_field :fare_medium, required: true, placeholder: "40000" %>
        <span class="unit">å††</span>
      </div>
    </div>

    <div>
      <%= form.label :fare_large, "å¤§å‹æ–™é‡‘" %><br>
      <div class="input-with-unit">
        <%= form.number_field :fare_large, required: true, placeholder: "50000" %>
        <span class="unit">å††</span>
      </div>
    </div>

    <%= form.submit "ç™»éŒ²" %>
  <% end %>
</div>

<h2 class="fare">ç™»éŒ²æ¸ˆæ¬é€æ–™ä¸€è¦§</h2>

<%= form_with url: fares_path, method: :get, local: true, html: { class: "search-bar" } do %>
  <div class="search-fields">
    <div class="select-group">
      <label>
        å‡ºç™ºåœ°
        <select name="departure" class="pad searchable-select">
          <option value="" <%= "selected" if @selected_departure.blank? %>>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="all" <%= "selected" if @selected_departure == "all" %>>å…¨ã¦</option>
          <% @grouped_departure_options.each do |group, options| %>
            <optgroup label="<%= group %>">
              <% options.each do |option| %>
                <option value="<%= option[:value] %>" data-furigana="<%= option[:furigana] %>" <%= "selected" if @selected_departure == option[:value] %>>
                  <%= option[:label] %>
                </option>
              <% end %>
            </optgroup>
          <% end %>
        </select>
      </label>

      <label>
        åˆ°ç€åœ°
        <select name="arrival" class="pad searchable-select">
          <option value="" <%= "selected" if @selected_arrival.blank? %>>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="all" <%= "selected" if @selected_arrival == "all" %>>å…¨ã¦</option>
          <% @grouped_arrival_options.each do |group, options| %>
            <optgroup label="<%= group %>">
              <% options.each do |option| %>
                <option value="<%= option[:value] %>" data-furigana="<%= option[:furigana] %>" <%= "selected" if @selected_arrival == option[:value] %>>
                  <%= option[:label] %>
                </option>
              <% end %>
            </optgroup>
          <% end %>
        </select>
      </label>
    </div>

    <div class="button-group-inline">
      <%= submit_tag "æ¤œç´¢", class: "btn-inline" %>
      <% if @selected_departure.present? || @selected_arrival.present? %>
        <%= link_to "ãƒªã‚»ãƒƒãƒˆ", fares_path, class: "btn-inline btn-reset-inline" %>
      <% end %>
    </div>
  </div>
<% end %>


<table>
  <thead>
    <tr>
      <th><%= sort_link("departure_furigana", "å‡ºç™ºåœ°") %></th>
      <th><%= sort_link("arrival_furigana", "åˆ°ç€åœ°") %></th>
      <th><%= sort_link("distance", "è·é›¢ï¼ˆkmï¼‰") %></th>
      <th><%= sort_link("fare_small", "å°å‹") %></th>
      <th><%= sort_link("fare_medium", "ä¸­å‹") %></th>
      <th><%= sort_link("fare_large", "å¤§å‹") %></th>
      <th>è©³ç´°</th>
    </tr>
  </thead>
  <tbody>
  <% grouped_fares = @fares.group_by(&:departure) %>
  <% grouped_fares.each do |departure, fares| %>
    <% fares.each_with_index do |fare, index| %>
      <tr>
        <% if index == 0 %>
          <td rowspan="<%= fares.size %>"><%= fare.departure %></td>
        <% end %>
        <td><%= fare.arrival %></td>
        <td><%= fare.distance.present? ? "#{fare.distance} km" : "-" %></td>
        <td><%= number_to_currency(fare.fare_small, unit: "\u00a5", precision: 0) %></td>
        <td><%= number_to_currency(fare.fare_medium, unit: "\u00a5", precision: 0) %></td>
        <td><%= number_to_currency(fare.fare_large, unit: "\u00a5", precision: 0) %></td>
        <td><%= link_to "è©³ç´°", fare_path(fare), class: "btn-table detail" %></td>
      </tr>
    <% end %>
  <% end %>
</tbody>

</table>


<style>
/* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒ•ã‚©ãƒ³ãƒˆ */
body {
  color: #2c3e50;
}

hr{
  margin: 2rem 0;
}

/* è¦‹å‡ºã— */
h1.fare, h2.fare {
  text-align: center;
  margin-top: 2rem;
  color: #2c3e50;
}

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
.toggle-button {
  background-color: #2c3e50;
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  font-size: 1.1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  font-weight: bold;
}

.toggle-button:hover {
  background: rgb(219, 216, 52);
  color: black;
}

/* ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ */
form {
  max-width: 640px;
  margin: 2rem auto;
  padding: 1.5rem;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

form label {
  display: block;
  font-weight: bold;
  margin-top: 1rem;
  color: #2c3e50;
  
}

form input[type="text"],
form input[type="number"],
form select {
  width: 95%;
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}

form input[type="submit"] {
  display: block;
  margin: 2rem auto 0;
  padding: 0.75rem 2rem;
  font-size: 1rem;
  background-color: #2c3e50;
  border: none;
  color: white;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

form input[type="submit"]:hover {
  background-color: rgb(219, 216, 52);
  color: black;
  font-weight: bold;
}

/* è·é›¢ãƒ»æ–™é‡‘æ¬„ã®å˜ä½è¡¨ç¤ºä»˜ã */
.input-with-unit {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.input-with-unit .unit {
  font-weight: bold;
  white-space: nowrap;
  color: #555;
}

/* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ï¼ˆç™½èƒŒæ™¯ã‚«ãƒ¼ãƒ‰ï¼‰ */
.search-bar {
  max-width: 800px;
  margin: 2rem auto;
  padding: 1.2rem 1.5rem 1.5rem;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
}

.search-fields {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 1rem;
}

.select-group {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

.select-group label {
  font-weight: bold;
}

.select-group select.pad {
  padding: 0.75rem 1rem;
  border-radius: 4px;
  border: 1.5px solid #2c3e50;
  min-width: 170px;
  font-size: 0.9rem;
}


/* æ¤œç´¢ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³æ¨ªä¸¦ã³ */
.button-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.button-group .btn,
.button-group .btn-reset {
  padding: 1rem 1rem;
  font-size: 1rem;
  border-radius: 4px;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: 0.2s ease;
}

.button-group .btn {
  background-color: #2c3e50;
  color: white;
}

.button-group .btn:hover {
  background-color: rgb(219, 216, 52);
  color: black;
}

.button-group .btn-reset {
  background-color: gray;
  color: white;
  text-decoration: none;
}

.button-group .btn-reset:hover {
  background-color: #999;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ */
table {
  table-layout: fixed;
  width: 100%;
  border-collapse: collapse;
  margin-top: 2rem;
  font-size: 0.95rem;
}

th, td {
  border: 1px solid #ddd;
  padding: 0.75rem;
  text-align: center;
  word-break: break-word;
}

tbody tr:nth-child(even) {
  background-color: #f5f5f5;
}

td[rowspan] {
  padding-top: 1.2rem;
  vertical-align: top;
}

/* === ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ + ã‚½ãƒ¼ãƒˆçŸ¢å°å¯¾å¿œ === */
thead {
  background-color: #2c3e50;
  color: white;
  border-bottom: none;
}
thead th {
  font-weight: bold;
  border: none;
  white-space: nowrap;
}
thead th a {
  color: white;
  text-decoration: none;
  display: inline-block;
  padding-right: 1.2rem;
  position: relative;
}
a.sortable::after {
  content: "â‡…";
  font-size: 0.75rem;
  margin-left: 0.4rem;
  opacity: 0.5;
}
a.sort-asc::after {
  content: "â–²";
  color: #ffd700;
  font-size: 0.75rem;
  margin-left: 0.4rem;
}
a.sort-desc::after {
  content: "â–¼";
  color: #ffd700;
  font-size: 0.75rem;
  margin-left: 0.4rem;
}

thead th.sort-desc a::after {
  content: "â–¼";
  color: #ffd700;
}

/* è©³ç´°ãƒœã‚¿ãƒ³ */
.btn-table.detail {
  background-color: #4b5866;
  color: white;
  padding: 0.4rem 0.8rem;
  border-radius: 4px;
  font-size: 0.9rem;
  text-decoration: none;
  font-weight: bold;
  display: inline-block;
}

.btn-table.detail:hover {
  background-color: #3a454f;
}

/* ğŸ”¹ ãƒ©ãƒ™ãƒ«ã¨ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ¨ªä¸€ä½“åŒ–ï¼ˆç¸¦æ–¹å‘ä¸­å¤®å¯„ã›ï¼‰ */
.select-group label {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-weight: bold;
  gap: 0.3rem;
}

/* ğŸ”¹ ãƒœã‚¿ãƒ³ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ä¸¦ã³ã« */
.button-group-inline {
  display: inline-flex;
  align-items: flex-start; /* ä¸Šæƒãˆã«å¤‰æ›´ */
  gap: 0.5rem;
  justify-content: center;
  margin-top: 0.5rem;
}

.btn-inline {
  padding: 0.5rem 1rem;
  font-size: 1rem;
  border-radius: 4px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  transition: 0.2s ease;
  background-color: #2c3e50;
  color: white;
  text-decoration: none;
}

.btn-inline:hover {
  background-color: rgb(219, 216, 52);
  color: black;
}

.btn-reset-inline {
    background-color: gray;
    margin-top: 32px; /* ğŸ”„ æ¤œç´¢ãƒœã‚¿ãƒ³ã¨æƒãˆã‚‹ãŸã‚ã«ä¿®æ­£ */
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    transition: 0.2s ease;
    color: white;
    text-decoration: none;
  }

  .btn-reset-inline:hover {
    background-color: #999;
    color: white;
  }

</style>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const departures = <%= raw Fare.select(:departure, :departure_furigana).distinct.to_json %>;
    const arrivals = <%= raw Fare.select(:arrival, :arrival_furigana).distinct.to_json %>;

    const depSelect = document.getElementById("departure-select");
    const arrSelect = document.getElementById("arrival-select");
    const depInput = document.getElementById("departure-input");
    const arrInput = document.getElementById("arrival-input");
    const depFurigana = document.getElementById("departure-furigana");
    const arrFurigana = document.getElementById("arrival-furigana");

    depSelect?.addEventListener("change", () => {
      if (depSelect.value) depInput.value = depSelect.value;
      const matched = departures.find(d => d.departure === depSelect.value);
      if (matched) depFurigana.value = matched.departure_furigana || "";
    });

    arrSelect?.addEventListener("change", () => {
      if (arrSelect.value) arrInput.value = arrSelect.value;
      const matched = arrivals.find(a => a.arrival === arrSelect.value);
      if (matched) arrFurigana.value = matched.arrival_furigana || "";
    });

    const button = document.getElementById("toggle-form");
    const form = document.getElementById("fare-form");
    button?.addEventListener("click", () => {
      const isHidden = form.style.display === "none";
      form.style.display = isHidden ? "block" : "none";
      button.textContent = isHidden ? "âˆ’ é‹è³ƒç™»éŒ²" : "ï¼‹ é‹è³ƒç™»éŒ²";
    });
  });
</script>